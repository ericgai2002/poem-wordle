<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>诗词 Wordle</title>
<style>
  body{font-family:"Helvetica Neue",Arial,sans-serif;text-align:center;padding:2rem;background:#f5f5f5}
  h1{margin-bottom:0.3rem}
  #lengthInfo{margin:0 0 1rem 0;font-size:18px;color:#555}
  #board{display:flex;flex-direction:column;gap:6px;align-items:center;margin-bottom:1rem}
  .row{display:flex;gap:6px}
  .tile{width:38px;height:38px;border:2px solid #d3d6da;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:bold;background:#fff;border-radius:4px;user-select:none}
  .correct{background:#6aaa64;border-color:#6aaa64;color:#fff}
  .present{background:#c9b458;border-color:#c9b458;color:#fff}
  .absent{background:#787c7e;border-color:#787c7e;color:#fff}
  #guess{font-size:20px;padding:6px;width:300px;border-radius:4px;border:1px solid #ccc;margin-bottom:0.5rem}
  #submit{font-size:18px;padding:6px 14px;border:none;border-radius:4px;background:#538d4e;color:#fff;cursor:pointer}
  #submit:disabled{background:#9aa0a6;cursor:not-allowed}
  #message{height:1.4rem;margin-top:0.5rem;color:#d32f2f}
</style>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js">
  (async () => {
  // 随机决定 10 还是 14 字
  const needLen = Math.random() < 0.5 ? 10 : 14;

  try{
    const poem = await fetchPoem(needLen);   // 动态拿诗句
    startGame(poem);                         // 启动游戏
  }catch(e){
    console.error('加载诗句失败，转用本地数组', e);

    // ---- 回退到本地题库 ----
    const fallback = POEMS.filter(p=>p.length===needLen);
    const poem = fallback[Math.floor(Math.random()*fallback.length)];
    startGame(poem);
  }
})();

</script>
</head>
<body>
  <h1>猜诗句 Wordle</h1>
  <p id="lengthInfo"></p>
  <div id="board"></div>
  <input id="guess" placeholder="输入完整诗句" maxlength="14" autofocus>
  <div>
    <button id="submit">提交</button>
  </div>
  <p id="message"></p>

<script>
  // -------- 动态获取 10/14 字诗句 ----------
function fetchPoem(lenNeeded) {
  return new Promise((resolve, reject) => {
    jinrishici.load(res => {
      // 去掉全部中文/英文标点与空白
      const sentence = res.data.content.replace(/[，。！？；,.!?;\\s]/g, '');
      if (sentence.length === lenNeeded) {
        resolve(sentence);
      } else {
        // 不合长度 → 递归再拉一次
        fetchPoem(lenNeeded).then(resolve).catch(reject);
      }
    }, err => reject(err));
  });
}
// --- 题库：5×2 和 7×2 诗句 ---
const poems10 = [
  "白日依山尽黄河入海流",
  "春眠不觉晓处处闻啼鸟",
  "会当凌绝顶一览众山小",
  "空山不见人但闻人语响",
  "江南可采莲莲叶何田田",
  "月黑雁飞高单于夜遁逃"
];

const poems14 = [
  "黄河远上白云间一片孤城万仞山",
  "葡萄美酒夜光杯欲饮琵琶马上催",
  "天生我材必有用千金散尽还复来"
];

const POEMS = poems10.concat(poems14);
// const answer = POEMS[Math.floor(Math.random() * POEMS.length)];
// const answerLen = answer.length; // 10 or 14

// 在页面顶部显示本局字数
// const lenInfoEl = document.getElementById('lengthInfo');
// lenInfoEl.textContent = `本局诗句共 ${answerLen} 字`;

function startGame(answer){
  const answerLen = answer.length;
  lenInfoEl.textContent = `本局诗句共 ${answerLen} 字`;
  // 其余原本对 answerLen / answer 的定义、事件绑定、函数等
  // 都保持不变，只要放到这个函数块里
}

const board = document.getElementById('board');
const input = document.getElementById('guess');
const submitBtn = document.getElementById('submit');
const msg = document.getElementById('message');

let attempts = 0;
const MAX_ATTEMPTS = 20;

submitBtn.addEventListener('click', handleGuess);
input.addEventListener('keypress', e => { if (e.key === 'Enter') handleGuess();});

function handleGuess(){
  const guessRaw = input.value.trim();
  if(guessRaw.length !== answerLen){
    showMessage(`需输入 ${answerLen} 个字，你输入了 ${guessRaw.length} 个。`);
    return;
  }
  if([...guessRaw].some(ch => /\s/.test(ch))){
    showMessage('请勿包含空格或标点');
    return;
  }
  attempts++;
  renderRow(guessRaw);
  if(guessRaw === answer){
    showMessage(`🎉 恭喜！你在第 ${attempts} 次猜中！`, true);
    endGame();
    return;
  }
  if(attempts >= MAX_ATTEMPTS){
    showMessage(`💡 机会用尽！答案是：${answer}`, true);
    endGame();
  } else {
    showMessage('');
  }
  input.value = '';
  input.focus();
}

function renderRow(guess){
  const row = document.createElement('div');
  row.className = 'row';

  const guessChars = [...guess];
  const answerChars = [...answer];
  const statusArr = Array(answerLen).fill('absent');

  // 标记正确位置
  guessChars.forEach((ch,i)=>{
    if(ch === answerChars[i]){
      statusArr[i] = 'correct';
      answerChars[i] = null;
    }
  });
  // 标记存在但位置不对
  guessChars.forEach((ch,i)=>{
    if(statusArr[i] !== 'correct' && answerChars.includes(ch)){
      statusArr[i] = 'present';
      answerChars[answerChars.indexOf(ch)] = null;
    }
  });

  // 渲染
  guessChars.forEach((ch,i)=>{
    const cell = document.createElement('span');
    cell.className = 'tile ' + statusArr[i];
    cell.textContent = ch;
    row.appendChild(cell);
  });
  board.appendChild(row);
  board.scrollTop = board.scrollHeight;
}

function showMessage(text, persistent=false){
  msg.textContent = text;
  if(!persistent && text){
    setTimeout(()=>{msg.textContent='';}, 2000);
  }
}

function endGame(){
  submitBtn.disabled = true;
  input.disabled = true;
}
</script>
</body>
</html>
